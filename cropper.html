<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  .button {
    position: absolute;
    width: 10px;
    height: 10px;
    background-color: blue;
    cursor: pointer;
    z-index: 1;
  }
</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

</head>
<body>
<input type="file" id="fileInput" accept="image/*">
<div style="position: relative;display: flex;width: fit-content;height: fit-content;align-items: center;justify-content: center;">
  <canvas id="canvas" style="box-shadow: #000 0 0 0 1px;"></canvas>
  <div id="selectionBox" style="position:absolute;box-shadow: inset red 0 0 0 1px;">
    <div id="topButton" class="button" style="top: -5px; transform: translateX(-50%);"></div>
    <div id="bottomButton" class="button" style="bottom: -5px; left: 100%; transform: translateX(-50%);"></div>
    <div id="leftButton" class="button" style="left: -5px; top: 100%; transform: translateY(-50%);"></div>
    <div id="rightButton" class="button" style="right: -5px; top: 0; transform: translateY(-50%);"></div>
  </div>
</div>
<canvas id="croppedCanvas" style="box-shadow: #000 0 0 0 1px; margin-top: 20px;"></canvas>
<div id="saveBtn">Save</div>
<script>
  const fileInput = document.getElementById('fileInput');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const selectionBox = document.getElementById('selectionBox');
  const croppedCanvas = document.getElementById('croppedCanvas');
  const croppedCtx = croppedCanvas.getContext('2d');
  const saveBtn =  document.getElementById('saveBtn');

  makeElementMovable(selectionBox, selectionBox, selectionBox.parentElement);
  let startX, startY, endX, endY;

  fileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    const reader = new FileReader();

    reader.onload = function(event) {
      const img = new Image();
      img.onload = function() {
        let width = img.width;
        let height = img.height;

        if (width > height) {
          if (width > 500) {
            height *= 500 / width;
            width = 500;
          }
        } else {
          if (height > 500) {
            width *= 500 / height;
            height = 500;
          }
        }

        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(img, 0, 0, width, height);

        const faspect = width / height;
        selectionBox.style.width = (faspect > 1 ? height : width)  + 'px';
        selectionBox.style.height = (faspect > 1 ? height : width) + 'px';
        drawCroppedImage();
      }
      img.src = event.target.result;
    }

    reader.readAsDataURL(file);
  });

  function drawCroppedImage(){
    const parentRect = selectionBox.parentElement.getBoundingClientRect();

    const rect = selectionBox.getBoundingClientRect();

    const x = rect.left - parentRect.left + window.scrollX;
    const y = rect.top - parentRect.top + window.scrollY;

    const width = rect.width;
    const height = rect.height;

    croppedCanvas.width = width;
    croppedCanvas.height = height;

    croppedCtx.drawImage(canvas, x, y, width, height, 0, 0, width, height);    
}


const topButton = document.getElementById('topButton');
const bottomButton = document.getElementById('bottomButton');
const leftButton = document.getElementById('leftButton');
const rightButton = document.getElementById('rightButton');


topButton.addEventListener('mousedown', function(e) {
    startY = e.clientY;
    startX = e.clientX;
    document.addEventListener('mousemove', handleTopMove);
    document.addEventListener('mouseup', function() {
        document.removeEventListener('mousemove', handleTopMove);
    });
});

bottomButton.addEventListener('mousedown', function(e) {
    startY = e.clientY;
    startX = e.clientX;
    document.addEventListener('mousemove', handleBottomMove);
    document.addEventListener('mouseup', function() {
        document.removeEventListener('mousemove', handleBottomMove);
    });
});

leftButton.addEventListener('mousedown', function(e) {
    startY = e.clientY;
    startX = e.clientX;
    document.addEventListener('mousemove', handleLeftMove);
    document.addEventListener('mouseup', function() {
        document.removeEventListener('mousemove', handleLeftMove);
    });
});

rightButton.addEventListener('mousedown', function(e) {
    startY = e.clientY;
    startX = e.clientX;
    document.addEventListener('mousemove', handleRightMove);
    document.addEventListener('mouseup', function() {
        document.removeEventListener('mousemove', handleRightMove);
    });
});

function handleTopMove(e) {
    const diffY = e.clientY - startY;
    const diffX = e.clientX - startX;
    const rect = selectionBox.getBoundingClientRect();
    if (Math.abs(diffX) > Math.abs(diffY)) {
        selectionBox.style.height = rect.height - diffX + 'px';
        selectionBox.style.width = rect.width - diffX + 'px';
    }
    else {
      selectionBox.style.height = rect.height - diffY + 'px';
      selectionBox.style.width = rect.width - diffY + 'px';
    }
    startY = e.clientY;
    startX = e.clientX;
    drawCroppedImage();
}

function handleBottomMove(e) {
    const diffY = e.clientY - startY;
    const diffX = e.clientX - startX;
    const rect = selectionBox.getBoundingClientRect();
    if (Math.abs(diffX) > Math.abs(diffY)) {
        selectionBox.style.height = rect.height + diffX + 'px';
        selectionBox.style.width = rect.width + diffX + 'px';
    }
    else {
      selectionBox.style.height = rect.height + diffY + 'px';
      selectionBox.style.width = rect.width + diffY + 'px';
    }
    startY = e.clientY;
    startX = e.clientX;
    drawCroppedImage();
}

function handleLeftMove(e) {
    const diffY = e.clientY - startY;
    const diffX = e.clientX - startX;
    const rect = selectionBox.getBoundingClientRect();
    if (Math.abs(diffX) > Math.abs(diffY)) {
        selectionBox.style.height = rect.height - diffX + 'px';
        selectionBox.style.width = rect.width - diffX + 'px';
    }
    else {
      selectionBox.style.height = rect.height + diffY + 'px';
      selectionBox.style.width = rect.width + diffY + 'px';
    }
    startY = e.clientY;
    startX = e.clientX;
    drawCroppedImage();
}

function handleRightMove(e) {
    const diffY = e.clientY - startY;
    const diffX = e.clientX - startX;
    const rect = selectionBox.getBoundingClientRect();
    if (Math.abs(diffX) > Math.abs(diffY)) {
        selectionBox.style.height = rect.height + diffX + 'px';
        selectionBox.style.width = rect.width + diffX + 'px';
    }
    else {
      selectionBox.style.height = rect.height - diffY + 'px';
      selectionBox.style.width = rect.width - diffY + 'px';
    }
    startY = e.clientY;
    startX = e.clientX;
    drawCroppedImage();
}

function makeElementMovable(elementSelector, handleSelector, containerSelector) {
    let isDragging = false;
    let offsetX, offsetY;

    const element = $(elementSelector);
    const handle = $(handleSelector);
    const container = $(containerSelector);

    handle.on('mousedown', (event) => {
        isDragging = true;
        offsetX = event.pageX - element.offset().left;
        offsetY = event.pageY - element.offset().top;
    });

    $(document).on('mousemove', (event) => {
      if (isDragging) {
          const newX = event.pageX - offsetX;
          const newY = event.pageY - offsetY;

          const containerRect = container[0].getBoundingClientRect();
          const elementRect = element[0].getBoundingClientRect();

          const maxX = containerRect.width - elementRect.width;
          const maxY = containerRect.height - elementRect.height;

          const constrainedX = Math.max(0, Math.min(newX, maxX));
          const constrainedY = Math.max(0, Math.min(newY, maxY));

          element.css({ left: constrainedX, top: constrainedY });
          drawCroppedImage();
      }
    });


    $(document).on('mouseup', () => {
        if (isDragging) {
            isDragging = false;
        }
    });
}

saveBtn.addEventListener('click', function(){
  saveCanvasAsImage(croppedCanvas, 'my_image.png');
});

function saveCanvasAsImage(canvas, filename) {
    const url = canvas.toDataURL(); 
    const link = document.createElement('a');
    link.href = url; 
    link.download = filename;
    link.click();
}

</script>
</body>
</html>
